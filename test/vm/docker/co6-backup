# Database Container
FROM backrest/co6-base

# Create BackRest user/group
RUN groupadd -g5000 postgres
RUN adduser -gpostgres -u5001 -n backrest

# Setup SSH
RUN mkdir /home/backrest/.ssh
COPY id_rsa  /home/backrest/.ssh/id_rsa
COPY id_rsa.pub  /home/backrest/.ssh/authorized_keys
RUN chown -R backrest:postgres /home/backrest/.ssh
RUN chmod 700 /home/backrest/.ssh
RUN echo 'Host *' > /home/backrest/.ssh/config
RUN echo '    StrictHostKeyChecking no' >> /home/backrest/.ssh/config
RUN echo '    LogLevel quiet' >> /home/backrest/.ssh/config

# Create pg_backrest.conf
RUN touch /etc/pg_backrest.conf
RUN chmod 640 /etc/pg_backrest.conf
RUN chown backrest:postgres /etc/pg_backrest.conf

# Setup repository
RUN mkdir /var/lib/backrest
RUN chown -R backrest:postgres /var/lib/backrest
RUN chmod 750 /var/lib/backrest

# Install Perl packages
RUN yum -y install perl perl-Time-HiRes perl-parent perl-JSON perl-Digest-SHA perl-DBD-Pg
